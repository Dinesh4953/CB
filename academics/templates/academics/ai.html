{% extends 'academics/base.html' %}

{% block body %}
<style>
  body, html {
    height: 100%;
    margin: 0;
    background-color: #0e0e0e;
    color: white;
    font-family: 'Segoe UI', sans-serif;
  }

  .chat-wrapper {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  .chat-box {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .chat-message {
    padding: 1rem;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
    white-space: normal;
  }

  .user-message {
    align-self: flex-end;
    background-color: #2a2a2a;
  }

  .ai-message {
    align-self: flex-start;
    background-color: #1f1f1f;
  }

  pre {
    background: #0b0b0b;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin-top: 0.8rem;
  }

  code {
    font-size: 0.9rem;
  }

  .input-bar {
    display: flex;
    padding: 1rem;
    background-color: #0e0e0e;
    border-top: 1px solid #333;
  }

  .input-bar textarea {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    border: none;
    resize: none;
    font-size: 1rem;
    background-color: #1a1a1a;
    color: white;
    outline: none;
  }

  .input-bar button {
    margin-left: 1rem;
    padding: 0.75rem 1.25rem;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }

  .placeholder {
    text-align: center;
    margin-top: auto;
    margin-bottom: auto;
  }
</style>

<div class="chat-wrapper">
  <div class="chat-box" id="chat-box">
    <div class="placeholder" id="welcome-text">
      <h1 style="font-size: 2.2rem; color: #00bcd4; font-weight: bold;">
        üëã Welcome to <span style="color:#1e90ff;">AI-Tutor</span>
      </h1>
      <p style="color: #aaa; font-size: 1.1rem; margin-top: 0.5rem;">
        Ask your programming questions below and get instant help!
      </p>
    </div>
  </div>

  <form method="post" class="input-bar" id="chat-form">
    {% csrf_token %}
    <textarea name="prompt" id="prompt-input" rows="1" placeholder="Ask Something..." required></textarea>
    <button type="submit">‚û§</button>
  </form>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Prism -->
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>

<script>
  const chatBox = $('#chat-box');

  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function appendMessage(text, type) {
    const message = $('<div></div>')
      .addClass('chat-message')
      .addClass(type === 'user' ? 'user-message' : 'ai-message');

    chatBox.append(message);

    if (type === 'ai') {
      let formatted = "";
      let lastIndex = 0;
      const regex = /```(\w+)?\n([\s\S]*?)```/g;
      let match;

      while ((match = regex.exec(text)) !== null) {
        // Text before code
        formatted += escapeHtml(text.slice(lastIndex, match.index))
          .replace(/\n/g, "<br>");

        const lang = match[1] || "python";
        const code = escapeHtml(match[2]);

        // Code block (preserve newlines)
        formatted += `
<pre><code class="language-${lang}">
${code}
</code></pre>`;

        lastIndex = regex.lastIndex;
      }

      // Remaining text
      formatted += escapeHtml(text.slice(lastIndex))
        .replace(/\n/g, "<br>");

      message.html(formatted);
      Prism.highlightAll();

    } else {
      message.text(text);
    }

    chatBox.scrollTop(chatBox[0].scrollHeight);
  }

  $('#chat-form').on('submit', function (e) {
    e.preventDefault();

    const prompt = $('#prompt-input').val().trim();
    if (!prompt) return;

    $('#welcome-text').remove();
    appendMessage(prompt, 'user');
    $('#prompt-input').val('');

    $.ajax({
      type: 'POST',
      url: '{% url "ask_gemini" %}',
      data: {
        prompt: prompt,
        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
      },
      success: function (data) {
        appendMessage(data.response, 'ai');
      },
      error: function () {
        appendMessage("‚ö†Ô∏è Something went wrong. Please try again.", 'ai');
      }
    });
  });
</script>
{% endblock %}
